<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>TTE</title>
    <link rel="stylesheet" type="text/css" href="../style.css">
    <link rel="webpage icon" href="../images/phone_logo.png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="background" onclick="blurFilter(event)">

        <!-- header -->
        <div class="header-box">
            <a href="user_homepage.html" target="_self" class="custom-logo-link">
                <h1 class="button-text">TTE<br>TEHNIKATARVETE ESMAABI</h1>
            </a>
            <img src="../images/phone_logo.png" alt="Phone Logo" class="phone-logo">
            <button class="profile-box" onclick="openPopup(event)" style="cursor: pointer">
                <p class="profile-text"><span id="username"></span></p>
                <img src="../images/profile.png" alt="Profile Picture" class="profile-picture">
            </button>
        </div>

        <!-- backbutton -->
        <a href="user_homepage.html" target="_self">
            <div class="back-button" style="top: 16%;left: 0.5%">
                <img src="../images/back_arrow.png" class="back-arrow">
            </div>
        </a>

        <!-- text box -->
        <div class="big-text-box" style="top: 16%;left: 12%; height: 10%;">
            <p class="button-text">Minu laenutatud tooted</p>
        </div>

        <!-- products
        <div class="product-container" style="top: 35%;left: 20%">
            <img class="product-picture" src="../images/usb_type_c.png" alt="USB type C">
            <div class="product-text-background">
                <ul class="profile-text">
                    <li>USB Type C laadija</li>
                    <li>2m</li>
                    <li>30W</li>
                </ul>
            </div>
            <div class="normal-button" style="top:75%;left:28%;width:50%;cursor: pointer" onclick="openPopupReturnProduct(event)">
                <p class="profile-text" style="left:1%">Tagasta toode</p>
            </div>
        </div>

        <div class="product-container" style="top: 35%;left: 55%">
            <img class="product-picture" src="../images/in_ear_headphones.png" alt="in-ear headphones">
            <div class="product-text-background">
                <ul class="profile-text">
                    <li>Kõrvasisesed kõrvaklapid</li>
                    <li>Type C ühendus</li>
                </ul>
            </div>
            <div class="normal-button" style="top:75%;left:28%;width:50%;cursor: pointer" onclick="openPopupReturnProduct(event)">
                <p class="profile-text" style="left: 1%;">Tagasta toode</p>
            </div>
        </div>
        I'll leave it here just in case I fuck up -->

        <!-- product table -->
        <table style="top: 30%; left: 30%">
            <tr><th>toode</th><th>Kogus</th><th>Tagasta</th></tr>
        </table>

    </div>

    <!-- popup -->
    <div class="popup" id="popup">
        <div class="small-box-purple" style="height: 50%; line-height: 150px"><b>Kas soovite välja logida?</b></div>
        <a href="../index.html" target="_self">
            <div class="normal-button" style="top: 43%;left: 29%;width: 40%;height: 30%; cursor: pointer;" onclick="openPopupConfirmation(event)">
                <p class="button-text">Jah</p>
            </div>
        </a>
        <div class="close-popup-btn" onclick="closePopup()" style="top: -8%; left: 93%; cursor: pointer;">
            <img src="../images/close-icon-13612.png">
        </div>
    </div>

    <div class="popup" id="popup2">
        <div class="small-box-purple" style="height: 50%; line-height: 150px"><b>Kas olete kindel?</b></div>
            <div class="normal-button" style="top: 43%;left: 29%;width: 40%;height: 30%; cursor: pointer;" onclick="openPopupConfirmation(event)">
                <p class="button-text">Jah</p>
            </div>
        <div class="close-popup-btn" onclick="closePopup()" style="top: -8%; left: 93%; cursor: pointer;">
            <img src="../images/close-icon-13612.png">
        </div>
    </div>

    <div class="popup" id="popup3">
        <div class="small-box-purple" style="height: 50%; line-height: 150px"><b>Tagastuskood:</b></div>
            <div class="normal-button" style="top: 43%;left: 29%;width: 40%;height: 30%;">
                <p class="button-text" id="randomCode"></p>
            </div>
        <div class="close-popup-btn" onclick="closePopup()" style="top: -8%; left: 93%; cursor: pointer;">
            <img src="../images/close-icon-13612.png">
        </div>
    </div>
    <script>
        $(document).ready(function() {
                generateRandomCode();
            });

        function openPopup(event){
            event.stopPropagation();
            $("#popup").addClass("open-popup");
            $(".background").addClass("blur-filter");
        }

        function closePopup(){
            $(".popup").removeClass("open-popup");
            $(".background").removeClass("blur-filter");
        }

        function openPopupReturnProduct(event){
            event.stopPropagation();
            $("#popup2").addClass("open-popup");
            $(".background").addClass("blur-filter");
            generateRandomCode();
        }

        function openPopupConfirmation(event, productIndex){
            event.stopPropagation();
            event.stopPropagation();
            $("#popup3").addClass("open-popup");
            $(".background").addClass("blur-filter");
            generateRandomCode();
            deleteProduct(productName, productQuantity);
        }

        function generateRandomCode() {
            var randomCode = Math.floor(100000 + Math.random() * 900000);
            document.getElementById("randomCode").innerText = randomCode;
        }

        const username = localStorage.getItem("username");
        document.getElementById("username").textContent = username;


    function fillTable() {
        var table = document.querySelector("table");
        var rentedProducts = JSON.parse(localStorage.getItem("rented_products")) || [];

        // Clear existing rows in the table
        table.innerHTML = "<tr><th>toode</th><th>Kogus</th><th>Tagasta</th></tr>";

        for (var i = 0; i < rentedProducts.length; i++) {
            if (rentedProducts[i].quantity > 0) { // Only add rows for products with quantity > 0
                var row = table.insertRow(-1);
                var cell1 = row.insertCell(0);
                var cell2 = row.insertCell(1);
                var cell3 = row.insertCell(2);

                cell1.innerHTML = rentedProducts[i].name;
                cell2.innerHTML = rentedProducts[i].quantity || 0;

                var popupButton = document.createElement("button");
                popupButton.textContent = "Tagasta";
                popupButton.classList.add("del-button", "button-text");
                popupButton.style.fontSize = "18px";
                popupButton.style.cursor = "pointer";

                popupButton.onclick = openPopupReturnProduct.bind(null, rentedProducts[i].name);

                cell3.appendChild(popupButton);
            }
        }
    }


    fillTable();

    function openPopupReturnProduct(productName) {
        $("#popup2").addClass("open-popup");
        $(".background").addClass("blur-filter");
        generateRandomCode();
        decreaseQuantity(productName);
    }

    function decreaseQuantity(productName) {
        var rentedProducts = JSON.parse(localStorage.getItem("rented_products")) || [];
        var index = rentedProducts.findIndex(product => product.name === productName);

        // Kontrollime, kas kogus on suurem kui 0
        if (index !== -1 && rentedProducts[index].quantity > 0) {
            rentedProducts[index].quantity -= 1;
            localStorage.setItem("rented_products", JSON.stringify(rentedProducts));
            fillTable();
        } else {
            // Kui kogus on 0, eemaldame vastava rea tabelist, kui see olemas on
            var table = document.querySelector("table");
            if (table.rows.length > index + 1) {
                table.deleteRow(index + 1); // +1, sest päise rida on ka tabelis
            }
        }
    }
    </script>
</body>
</html>